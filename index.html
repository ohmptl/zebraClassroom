<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Classroom Loudness Monitor</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    .left-panel {
      width: 50vw;
      min-width: 320px;
      background: #fff;
      box-shadow: 2px 0 8px rgba(0,0,0,0.07);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 40px 32px 32px 48px;
      box-sizing: border-box;
      border-right: 2px solid #e0e0e0;
    }
    #clock-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 40px;
    }
    #clock-box {
      display: flex;
      align-items: baseline;
      justify-content: center;
      margin-right: 24px;
    }
    #clock {
      font-size: 3.5em;
      color: #1976d2;
      font-weight: bold;
      letter-spacing: 2px;
      margin-right: 12px;
      margin-bottom: 0;
      text-align: center;
    }
    #ampm {
      font-size: 1.2em;
      color: #1976d2;
      font-weight: bold;
      margin-left: 4px;
      align-self: flex-end;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }
    #countdown-box {
      background: #e3f0fc;
      border-radius: 18px;
      box-shadow: 0 2px 12px rgba(25,118,210,0.08);
      padding: 18px 32px 14px 32px;
      min-width: 160px;      /* Match clock-box min-width */
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #countdown {
      font-size: 3.5em;      /* Match clock font size */
      font-weight: bold;
      color: #1976d2;
      transition: color 0.3s, background 0.3s;
      letter-spacing: 2px;
    }
    .schedule {
      width: 100%;
      margin-top: 0;
    }
    .schedule-title {
      font-size: 1.7em;
      font-weight: bold;
      margin-bottom: 18px;
      color: #333;
    }
    .schedule-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 1.3em; /* Reduced from 2em for better fit */
      width: 100%;
    }
    .schedule-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.9vw;
      padding: 0.9vw 0;
      border-bottom: 2px solid #eee;
      width: 100%;
      transition: background 0.3s, color 0.3s;
      box-sizing: border-box;
      position: relative;
      z-index: 1;
    }
    .schedule-list li.active {
      background: #1976d2;
      color: #fff;
      border-radius: 16px;
      font-weight: bold;
      box-shadow: 0 2px 12px rgba(25,118,210,0.08);
      padding-left: 24px;
      padding-right: 24px;
      margin-left: -12px;
      margin-right: -12px;
      border-bottom: none;
      z-index: 2;
    }
    .schedule-list li.active .schedule-time,
    .schedule-list li.active .schedule-name {
      color: #fff !important;
    }
    .schedule-name {
      text-align: left;
      flex: 1 1 60%;
      font-weight: 500;
      color: #222;
    }
    .schedule-time {
      text-align: right;
      flex: 1 1 40%;
      color: #1976d2;
      font-family: monospace;
      font-size: 1em;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .right-panel {
      width: 50vw;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 0 0 0;
      box-sizing: border-box;
    }
    .sound-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    .meter {
      width: 400px;
      max-width: 90vw;
      height: 40px;
      background: #ddd;
      border-radius: 8px;
      overflow: hidden;
      margin: 32px 0 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .bar {
      height: 100%;
      background: green;
      width: 0%;
      transition: width 0.1s, background 0.2s;
    }
    .stats {
      margin: 16px 0 0 0;
      font-size: 1.2em;
      text-align: center;
      width: 400px;
      max-width: 90vw;
    }
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      justify-content: center;
    }
    .stats button {
      padding: 10px 24px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      min-width: 120px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    }
    .stats button:hover {
      background: #1565c0;
    }
    .stats button:active {
      background: #0d47a1;
    }
    #lostTime {
      margin-top: 18px;
      font-size: 1.3em;
      color: #333;
    }
    .screen-off-note {
      margin-top: 10px;
      font-size: 2em;
      font-weight: bold;
      color: #d32f2f;
    }
    #thresholdSlider {
      width: 100%;
      margin-top: 18px;
    }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .left-panel, .right-panel { width: 100vw; min-width: 0; }
      .left-panel { padding: 18px; border-right: none; border-bottom: 2px solid #e0e0e0; }
      .right-panel { padding: 18px 0 0 0; }
      .meter, .stats { width: 98vw; }
      .schedule-list { font-size: 1em; }
      .schedule-list li { margin-bottom: 8px; padding: 6px 0; }
    }
    /* Add this to your <style> section */
    .left-panel.fullscreen-schedule {
      display: flex !important;
      flex-direction: column;
      align-items: center !important;
      justify-content: flex-start;
      padding-top: 16px !important;      /* Reduce top padding */
      padding-bottom: 16px !important;   /* Reduce bottom padding */
      min-height: 100vh;
      height: 100vh;                     /* Ensure full height */
      overflow-y: hidden !important;      /* Prevent vertical scroll bar */
    }

    .schedule.fullscreen-schedule {
      width: 46vw !important;          /* Slightly smaller for safety */
      max-width: 680px !important;     /* Slightly smaller for safety */
      margin: 12px auto 0 auto !important;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 4px 32px rgba(25,118,210,0.08);
      padding: 18px 0 18px 0 !important;      /* Reduced padding */
    }

    .schedule-list.fullscreen-schedule li {
      font-size: 1.15em !important; /* Slightly smaller text */
      padding-left: 24px !important;
      padding-right: 24px !important;
    }

    #clock-container {
      margin-bottom: 18px !important;      /* Reduce space below time/timer */
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <!-- Add this button inside .left-panel, above #clock-container -->
      <button id="fullscreenSchedule" title="Fullscreen Schedule" style="position:absolute;top:12px;right:12px;padding:4px 10px;font-size:1em;border-radius:8px;border:none;background:rgba(180,180,180,0.18);color:#444;cursor:pointer;z-index:10;">â›¶</button>
      <div id="clock-container">
        <div id="clock-box" style="background:#e3f0fc;border-radius:18px;box-shadow:0 2px 12px rgba(25,118,210,0.08);padding:18px 32px 14px 32px;min-width:160px;min-height:48px;display:flex;align-items:center;margin-right:24px;">
          <span id="clock" style="font-size:3.5em;color:#1976d2;font-weight:bold;letter-spacing:2px;margin-right:12px;margin-bottom:0;text-align:center;"></span>
          <span id="ampm" style="font-size:1.2em;color:#1976d2;font-weight:bold;margin-left:4px;align-self:flex-end;margin-bottom:8px;letter-spacing:1px;"></span>
        </div>
        <div id="countdown-box" style="background:#e3f0fc;border-radius:18px;box-shadow:0 2px 12px rgba(25,118,210,0.08);padding:18px 32px 14px 32px;min-width:160px;min-height:48px;display:flex;align-items:center;justify-content:center;">
          <span id="countdown" style="font-size:3.5em;font-weight:bold;color:#1976d2;transition:color 0.3s,background 0.3s;letter-spacing:2px;"></span>
        </div>
      </div>
      <div class="schedule">
        <div class="schedule-title">Today's Schedule</div>
        <ul class="schedule-list" id="scheduleList">
          <li data-start="09:00" data-end="10:30"><span class="schedule-name"><b>Session #1:</b></span><span class="schedule-time">9:00 AM - 10:30 AM</span></li>
          <li data-start="10:30" data-end="10:45"><span class="schedule-name"><b>Snack #1:</b></span><span class="schedule-time">10:30 AM - 10:45 AM</span></li>
          <li data-start="10:45" data-end="11:15"><span class="schedule-name"><b>Screen Off #1:</b></span><span class="schedule-time">10:45 AM - 11:15 AM</span></li>
          <li data-start="11:15" data-end="12:00"><span class="schedule-name"><b>Session #2:</b></span><span class="schedule-time">11:15 AM - 12:00 PM</span></li>
          <li data-start="12:00" data-end="13:00"><span class="schedule-name"><b>Lunch:</b></span><span class="schedule-time">12:00 PM - 1:00 PM</span></li>
          <li data-start="13:00" data-end="14:30"><span class="schedule-name"><b>Session #3:</b></span><span class="schedule-time">1:00 PM - 2:30 PM</span></li>
          <li data-start="14:30" data-end="14:45"><span class="schedule-name"><b>Snack #2:</b></span><span class="schedule-time">2:30 PM - 2:45 PM</span></li>
          <li data-start="14:45" data-end="15:15"><span class="schedule-name"><b>Screen Off #2:</b></span><span class="schedule-time">2:45 PM - 3:15 PM</span></li>
          <li data-start="15:15" data-end="16:00"><span class="schedule-name"><b>Session #4:</b></span><span class="schedule-time">3:15 PM - 4:00 PM</span></li>
        </ul>
      </div>
    </div>
    <div class="right-panel">
      <div class="sound-content">
        <h1 style="margin-bottom:0.5em;text-align:center;">ðŸ“¢ Classroom Loudness Monitor</h1>
        <div class="meter">
          <div class="bar" id="bar"></div>
        </div>
        <div class="stats">
          <p>Volume: <span id="volume">0</span> dB</p>
          <p>Threshold: <span id="threshold">70</span> dB</p>
          <p>Exceed Count: <span id="count">0</span></p>
          <div class="btn-group">
            <button id="reset">Reset Count</button>
            <button id="toggleAudio">Start</button>
          </div>
          <input type="range" id="thresholdSlider" min="30" max="100" value="70">
          <div id="lostTime" class="screen-off-note">Currently you've lost 0 minutes of screen time</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Clock update
    function updateClock() {
      const now = new Date();
      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      if (hours === 0) hours = 12;
      document.getElementById("clock").textContent = `${hours}:${minutes}:${seconds}`;
      document.getElementById("ampm").textContent = ampm;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Loudness logic
    const volumeText = document.getElementById("volume");
    const bar = document.getElementById("bar");
    const countText = document.getElementById("count");
    const thresholdText = document.getElementById("threshold");
    const thresholdSlider = document.getElementById("thresholdSlider");
    const resetBtn = document.getElementById("reset");
    const toggleBtn = document.getElementById("toggleAudio");

    let count = 0;
    let threshold = parseInt(thresholdSlider.value);
    let exceeded = false;
    let lastIncrementTime = 0;
    let audioRunning = false;
    let audioContext, analyser, source, dataArray, animationId, stream;

    function updateScreenTime() {
      const lostMinutes = count * 2;
      document.getElementById("lostTime").textContent = `Currently you've lost ${lostMinutes} minute${lostMinutes === 1 ? "" : "s"} of screen time`;
    }

    resetBtn.onclick = () => {
      count = 0;
      countText.textContent = count;
      updateScreenTime();
    };

    thresholdSlider.oninput = () => {
      threshold = parseInt(thresholdSlider.value);
      thresholdText.textContent = threshold;
    };

    async function startAudio() {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      source.connect(analyser);

      dataArray = new Uint8Array(analyser.frequencyBinCount);

      function getVolume() {
        analyser.getByteTimeDomainData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          let val = (dataArray[i] - 128) / 128;
          sum += val * val;
        }
        let rms = Math.sqrt(sum / dataArray.length);
        let db = 20 * Math.log10(rms);
        db = Math.max(-100, Math.min(db + 70, 100));
        return db;
      }

      function update() {
        const db = getVolume();
        volumeText.textContent = db.toFixed(1);

        const percent = Math.min(100, Math.max(0, db));
        bar.style.width = percent + "%";
        bar.style.background = db >= threshold ? "red" : "green";

        // --- Begin flashing logic ---
        if (db >= threshold) {
          const now = Date.now();
          if (!exceeded && now - lastIncrementTime > 3000) { // 3 second cooldown
            count++;
            countText.textContent = count;
            updateScreenTime();
            exceeded = true;
            lastIncrementTime = now;
            startFlashing(); // <-- Only call startFlashing when count increments
          }
        } else {
          exceeded = false;
        }

        animationId = requestAnimationFrame(update);
      }

      update();
    }

    function stopAudio() {
      if (animationId) cancelAnimationFrame(animationId);
      if (audioContext) audioContext.close();
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      bar.style.width = "0%";
      volumeText.textContent = "0";
      stopFlashing();
    }

    toggleBtn.onclick = async () => {
      if (!audioRunning) {
        await startAudio();
        toggleBtn.textContent = "Stop";
        audioRunning = true;
      } else {
        stopAudio();
        toggleBtn.textContent = "Start";
        audioRunning = false;
      }
    };

    window.onload = updateScreenTime;

    function highlightCurrentBlock() {
      const now = new Date();
      let h = now.getHours();
      let m = now.getMinutes();
      const current = h * 60 + m;

      document.querySelectorAll('#scheduleList li').forEach(li => {
        const [startH, startM] = li.dataset.start.split(':').map(Number);
        const [endH, endM] = li.dataset.end.split(':').map(Number);
        let start = startH * 60 + startM;
        let end = endH * 60 + endM;
        // Handle PM times for afternoon blocks
        if (startH < 8) start += 12 * 60;
        if (endH < 8) end += 12 * 60;
        // Special case for 12:00-1:00 PM
        if (startH === 12) start = 12 * 60 + startM;
        if (endH === 12) end = 12 * 60 + endM;
        // Highlight if now is in this block
        if (current >= start && current < end) {
          li.classList.add('active');
        } else {
          li.classList.remove('active');
        }
      });
    }
    setInterval(highlightCurrentBlock, 10000);
    highlightCurrentBlock();

    // Add these variables and functions above startAudio()
    let flashTimeout = null;
    let flashing = false;
    function startFlashing() {
      if (flashing) return;
      flashing = true;
      let flashOn = false;
      function flashStep() {
        document.body.style.backgroundColor = flashOn ? "#ffcccc" : "#fff";
        flashOn = !flashOn;
        flashTimeout = setTimeout(() => {
          if (flashing) flashStep();
        }, 200);
      }
      flashStep();
      setTimeout(() => {
        stopFlashing();
      }, 5000);
    }
    function stopFlashing() {
      flashing = false;
      clearTimeout(flashTimeout);
      document.body.style.backgroundColor = "#f2f2f2";
    }

    function getNextBlockTime() {
      const now = new Date();
      let h = now.getHours();
      let m = now.getMinutes();
      const current = h * 60 + m;
      let minDiff = Infinity;
      let nextBlock = null;
      let lastEnd = null;

      document.querySelectorAll('#scheduleList li').forEach(li => {
        const [startH, startM] = li.dataset.start.split(':').map(Number);
        const [endH, endM] = li.dataset.end.split(':').map(Number);
        let start = startH * 60 + startM;
        let end = endH * 60 + endM;
        // Handle PM times for afternoon blocks
        if (startH < 8) start += 12 * 60;
        if (endH < 8) end += 12 * 60;
        if (startH === 12) start = 12 * 60 + startM;
        if (endH === 12) end = 12 * 60 + endM;
        if (start > current && start - current < minDiff) {
          minDiff = start - current;
          nextBlock = start;
        }
        // Track the end of the last block
        if (!lastEnd || end > lastEnd) lastEnd = end;
      });

      // If no next block, count down to the end of the last block (if still in schedule)
      if (minDiff === Infinity && lastEnd && current < lastEnd) {
        return lastEnd - current;
      }
      return minDiff !== Infinity ? minDiff : null;
    }

    let countdownFlashInterval = null;
    function updateCountdown() {
      const countdownSpan = document.getElementById("countdown");
      const minDiff = getNextBlockTime();
      if (minDiff === null) {
        countdownSpan.textContent = "";
        countdownSpan.style.background = "";
        countdownSpan.style.color = "#1976d2";
        if (countdownFlashInterval) {
          clearInterval(countdownFlashInterval);
          countdownFlashInterval = null;
        }
        return;
      }
      const min = Math.floor(minDiff);
      const sec = Math.floor((minDiff - min) * 60);
      const now = new Date();
      const totalSec = (minDiff * 60) - now.getSeconds();
      const displayMin = Math.floor(totalSec / 60);
      const displaySec = (totalSec % 60 + 60) % 60;
      countdownSpan.textContent = `${displayMin}:${displaySec.toString().padStart(2, "0")}`;
      // Flash red if within 2 minutes
      if (minDiff <= 2) {
        if (!countdownFlashInterval) {
          let flashOn = false;
          countdownFlashInterval = setInterval(() => {
            countdownSpan.style.background = flashOn ? "#ffcccc" : "";
            countdownSpan.style.color = flashOn ? "#d32f2f" : "#1976d2";
            flashOn = !flashOn;
          }, 400);
        }
      } else {
        countdownSpan.style.background = "";
        countdownSpan.style.color = "#1976d2";
        if (countdownFlashInterval) {
          clearInterval(countdownFlashInterval);
          countdownFlashInterval = null;
        }
      }
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();

    const fullscreenBtn = document.getElementById("fullscreenSchedule");
    const leftPanel = document.querySelector(".left-panel");
    const rightPanel = document.querySelector(".right-panel");
    const scheduleDiv = document.querySelector('.schedule');
    const scheduleList = document.querySelector('.schedule-list');

    let scheduleFullscreen = false;
    fullscreenBtn.onclick = () => {
      scheduleFullscreen = !scheduleFullscreen;
      if (scheduleFullscreen) {
        leftPanel.classList.add('fullscreen-schedule');
        scheduleDiv.classList.add('fullscreen-schedule');
        scheduleList.classList.add('fullscreen-schedule');
        Array.from(scheduleList.children).forEach(li => li.classList.add('fullscreen-schedule'));
        leftPanel.style.width = "100vw";
        leftPanel.style.position = "fixed";
        leftPanel.style.top = "0";
        leftPanel.style.left = "0";
        leftPanel.style.height = "100vh";
        leftPanel.style.zIndex = "100";
        rightPanel.style.display = "none";
        fullscreenBtn.textContent = "âœ•";
      } else {
        leftPanel.classList.remove('fullscreen-schedule');
        scheduleDiv.classList.remove('fullscreen-schedule');
        scheduleList.classList.remove('fullscreen-schedule');
        Array.from(scheduleList.children).forEach(li => li.classList.remove('fullscreen-schedule'));
        leftPanel.style.width = "";
        leftPanel.style.position = "";
        leftPanel.style.top = "";
        leftPanel.style.left = "";
        leftPanel.style.height = "";
        leftPanel.style.zIndex = "";
        rightPanel.style.display = "";
        fullscreenBtn.textContent = "â›¶";
      }
    };
  </script>
</body>
</html>
